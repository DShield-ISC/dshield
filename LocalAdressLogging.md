# Dshield honeypot

## Logging acces to the honeypot from local addresses

### Introduction

The DShield-ISC honeypot packet provides a general honeypot system to monitor unwanted IP packets from the global internet. This honeypot system is normally located behind a router within a local address space and the router uses NAT to reroute this unwanted traffic to the honeypot. There is a request to monitor also unwanted traffic to the honeypot coming from the local network. This note describes how to implement the logging of this type of traffic.

In view of the particular demand for this enhancement it was decided not to implement it in the <i>install.sh</i> script but to document it here and to leave the real implementation to the one who wants it.

### Implementation

The filtering of IP packages is done using iptables or nftables and the corresponding files are <i>/etc/network/iptables</i> or <i>/etc/network/ruleset.nft</i>, which are generated by the <i>install.sh</i> script.

The recommended way is to use the feature in <i>install.sh</i>, which calls the script <i>/root/bin/postinstall.sh</i>, if it is present, just before finishing the <i>install.sh</i> script. This is used to do some final adjustments to suit your particular needs after an install or update. Note that running <i>install.sh</i> almost completely installs a fresh version, so any change you made previously in the honeypot system, must be redone.

There are three actions to perform, apart from the reboot you should do after running <i>install.sh</i>.
<ol>
<li>Add two lines to one of the above mentioned two files which is generated by the <i>install.sh</i> script.
    <ol>
    <li>To <i>/etc/network/iptables</i> add after the line with <b>-N DSHIELDLOG</b>:
<code><pre>
 -A DSHIELDLOG -s &lt;IP_range&gt; -j LOG â€“log-prefix " LOCALINPUT "
 -A DSHIELDLOG -s &lt;IP_range&gt; -j RETURN
</pre></code>
    </li>


    <li>To <i>/etc/network/ruleset.nft</i> add after the line with <b>add chain ip nat DSHIELDLOG<b>:
<code><pre>
 add rule ip nat DSHIELDLOG ip saddr &lt;IP_range&gt; counter log prefix " LOCALINPUT "
 add rule ip nat DSHIELDLOG ip saddr &lt;IP_range&gt; counter return
</pre></code>
    </li>
    </ol>

Where &lt;IP_range&gt; is something like <b>10.0.128.0/23</b>; it should be an address range which is not allowed for global IP addresses.
In case you need more that one separate ranges of IP addresses, you have to add for each range these two lines. You can use other text for
LOCALINPUT. Note the spaces around this text.

It is recommended to create a .patch file and use the patch utility in <tt>/root/bin/postinstall.sh</tt> to change the above mentioned file.
</li>


<li>The lines with LOCALINPUT are send to the syslog and will end up in <i>/var/log/filewall</i>, but you can put these lines in a separate file like <i>/var/log/localinput.log</i> by providing the file <i>/etc/rsyslog.d/localinput.conf</i> with the following content:
<code><pre>
 $template LinputTemplate,"%timegenerated:::date-unixtimestamp% %HOSTNAME% %syslogtag%%msg%\n"
 if $msg contains " LOCALINPUT " then /var/log/localinput.log;LinputTemplate
 &amp; stop
</pre></code>
The last line will prevent these log lines to enter the firewall logfile <i>/var/log/firewall</i>.
</li>


<li>To keep the number of these logfiles controlled, you can manage them in the logrotate system. Append " <b>/var/log/localinput.log</b>", without the double quotes, after <b>/var/log/dshield.log</b> in <i>/etc/logrotate.d/dshield</i>, which is installed by <i>install.sh</i>. So you could use patch to change that file using <i>/root/bin/postinstall.sh</i>.
</li></ol>
### Further processing
It is left to the user of this system to further process the generated logfile <i>/var/log/localinput.log</i>.
### Final remark
The system with nftables has been tested by the author, he believes that what has been presented for
iptables will work as well, but no garanties.
